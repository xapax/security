<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="xapax">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Android Testing Environment Setup - Notes</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Introduction", url: "#_top", children: [
          ]},
          {title: "Setup", url: "#setup", children: [
          ]},
          {title: "Android", url: "#android", children: [
          ]},
          {title: "API-test - Configuration", url: "#api-test-configuration", children: [
              {title: "Invisible intercept", url: "#invisible-intercept" },
              {title: "Use proxy-settings on your phone", url: "#use-proxy-settings-on-your-phone" },
          ]},
          {title: "Installing drozer", url: "#installing-drozer", children: [
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../android_tools/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../android_tools/" class="btn btn-xs btn-link">
        Tools
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../../attacking_active_directory_domain/attacking_windows_domain_local_privilege_escalation/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../../attacking_active_directory_domain/attacking_windows_domain_local_privilege_escalation/" class="btn btn-xs btn-link">
        Local Privilige Escalation
      </a>
    </div>
    
  </div>

    

    <h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>There is no point in reinventing the wheel. So instead of explaining all the possible vectors here it might be easier to use the OWASP Mobile Testing framework.</p>
<p>OWASP has provided two resources that are very useful.</p>
<ol>
<li>OWASP Mobile Security Testing Guide</li>
<li>Mobile App Security Checklist</li>
</ol>
<p>The guide and the checklist goes hand in hand. And the checklist refers to the guide quite often.
 The guide and the checklist concerns both Android and iPhone.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">#</a></h2>
<h2 id="android">Android<a class="headerlink" href="#android" title="Permanent link">#</a></h2>
<p>We wan to do three different things to test the application: static analysis, dynamic analysis and api-analysis.</p>
<p>Static analysis simply refers to inspecting the contents of the application package. In android this is an apk-file. The static analysis can be done using MobSF in linux. A dynamic analysis refers to analysis of the package when it is running. To analyse that we will use Drozer.</p>
<h2 id="api-test-configuration">API-test - Configuration<a class="headerlink" href="#api-test-configuration" title="Permanent link">#</a></h2>
<p>What we want to do is to be able to send the mobile applications traffic to burp to inspect the http traffic.
 This can be done in two ways. By proxying the phones traffic to your burp instance, or set up an access point and MITM the phone that way.</p>
<h3 id="invisible-intercept">Invisible intercept<a class="headerlink" href="#invisible-intercept" title="Permanent link">#</a></h3>
<p>So this technique works by creating a access-point that your mobile phone connects to, and then man-in-the-middle all the traffic through iptables.</p>
<ul>
<li>Redirect the network-card to your VM</li>
</ul>
<p>The first problem I ran into was that the USB-adapter wouldnâ€™t be redirected into the virtual machine. I looked in syslog when I tried to redirect it, and I noticed some error messages from apparmor. It was something like this:</p>
<pre><code> apparmor=&quot;DENIED&quot; operation=&quot;open&quot; profile=&quot;libvirt-...&quot; name=&quot;/run/udev/data/+usb&quot; comm=&quot;qemu-system-x86&quot;

</code></pre>

<p>The command was <code>qemu-system-x86</code>, and the operation was <code>open</code>, but apparmor denied the action. After some googeling I figured out that I need to edit the apparmor profile for libvirt-qemu. So I edited this file like this:</p>
<pre><code>sudo vim /etc/apparmor.d/abstractions/libvirt-qemu
</code></pre>

<pre><code># For hostdev access. The actual devices will be added dynamically
/sys/bus/usb/devices/ r,
/sys/devices/**/usb[0-9]*/** r,

# THIS LINE NEEDS TO BE ADDED
/run/udev/data/* rw,
</code></pre>

<ul>
<li>Add USB to Virtual Machine</li>
</ul>
<p>If the USB adapter is using USB 3 you might need to change the USB Controller in virt-manager to USB 3. Just change it in Controller USB from 2 to 3. Next you go to <code>Add Hardware</code>, <code>USB Host Device</code>. Another way is to open the VM in spicy/virt-manager and then go to Input/Select USB Devices for Redirection. That usually doesn't work for me though.</p>
<p>Verify that the USB-adapter is connected by either checking <code>ifconfig</code> or <code>lsusb</code>. Hopefully you will see the wlan0 network interface.</p>
<ul>
<li>Create a hotspot</li>
</ul>
<p>If you have network-manager it is really simple to set up an access-point. Open up network-manager:</p>
<pre><code>nm-connection-editor
</code></pre>

<p>Then you click <code>Add</code> select <code>Wi-fi</code>. You name the hotspot and change <code>Mode</code> from <code>Client</code> to <code>Hotspot</code>. Then you edit wifi-security, and click <code>Save</code>.</p>
<p>Now you should have a working hotspot. You can verify it by looking for it from your host or smartphone. Now just connect to it from the smartphone you want to MITM.</p>
<p>You should now be able to see the phones traffic passing by. You can use tcpdump to see that it works.</p>
<p>If your device connects but does not get an IP it is probably because you are missing a dhcp-server. You just need to install dnsmasq, and network manager will figure out the rest.</p>
<pre><code>tcpdump -i wlan0
</code></pre>

<ul>
<li>Redirect traffic to Burp through iptables</li>
</ul>
<pre><code class="bash">apt-get install iptables-persistent

iptables-save &gt; rules

# Then you edit the rules and add them by:

iptables-restore &lt; rules

</code></pre>

<p>So these are the rules to be added. The ip-address is the address for the smartphone that we want to intercept.</p>
<pre><code class="bash">:PREROUTING ACCEPT [414:27612]
-A PREROUTING -i wlan0 -s 10.41.1.121 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8080
-A PREROUTING -i wlan0 -s 10.42.0.121 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080
-A PREROUTING -i wlan0 -s 10.42.0.121 -p tcp -m tcp --dport 53 -j REDIRECT --to-ports 53


:POSTROUTING ACCEPT [289:20303]
-A  POSTROUTING -j MASQUERADE
</code></pre>

<ul>
<li>Configure BURP</li>
</ul>
<p>Now you just need to configure burp.</p>
<p>go to <code>Proxy/options/Proxy Listener/Add/Choose your interface and port</code>.
Then Click on <code>Request Handeling</code> and then <code>Support invisible proxying</code>.</p>
<ul>
<li>Import Burp certificate</li>
</ul>
<p>Now you need to import you burp-certificate to you phone, in order to handle HTTPS traffic.</p>
<p>Remember that this will not work if the application you are assessing is using certificate pinning.</p>
<p>Open the web browser in your phone and go to your machines ip-address on port 8080 (or whatever port burp is listening on).</p>
<p>Download the burp-certificate.
Rename it to <code>cacert.cer</code></p>
<p>Go to <code>settings</code>, <code>security</code>, <code>install from storage</code>. And then select your cerrificate.</p>
<ul>
<li>Get the application on to the phone.</li>
</ul>
<p>This is usually a really simple process. Just store the apk on your attacking-machine and have the phone download it through a webserver</p>
<pre><code class="bash">python -m SimpleHTTPServer 80

</code></pre>

<h3 id="use-proxy-settings-on-your-phone">Use proxy-settings on your phone<a class="headerlink" href="#use-proxy-settings-on-your-phone" title="Permanent link">#</a></h3>
<p>The other way of doing it is simply to set up your hotspot, and then connect the phone onto the hotspot and then configure the phone to go tospecific proxy settings.</p>
<p>So you go to Settings/wifi/(hold on the specified network/modify network/proxy/manual.
Scroll down and then input the ip address of your hotspot, for example 10.42.0.1 and the proxy port: 8080.</p>
<p>Now you need to configure burp to listen to your wifi interface.
Proxy/Options/Proxy listener</p>
<h2 id="installing-drozer">Installing drozer<a class="headerlink" href="#installing-drozer" title="Permanent link">#</a></h2>
<p>Download drozer here:
https://github.com/mwrlabs/drozer/releases</p>
<pre><code class="bash">sudo dpkg -i drozer.deb
sudo apt install -f
</code></pre>

<p>Install drozer on phone. Start it. Check the settings that a password is set.</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../android_tools/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../android_tools/" class="btn btn-xs btn-link">
        Tools
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../../attacking_active_directory_domain/attacking_windows_domain_local_privilege_escalation/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../../attacking_active_directory_domain/attacking_windows_domain_local_privilege_escalation/" class="btn btn-xs btn-link">
        Local Privilige Escalation
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/xapax/edit/master/docs/attacking_mobile_applications/android/mobile_application_setup.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>